<!DOCTYPE html>
<html>
<head>
  <title>Загрузка файлов</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #file-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #file-input {
      margin: 10px;
    }
    #submit-button {
      margin: 10px;
      padding: 5px 10px;
      border: 1px solid #000;
      border-radius: 5px;
      background-color: #000;
      color: #fff;
      cursor: pointer;
    }
    #search-form {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #search-input {
      margin: 10px;
    }
    #search-button {
      margin: 10px;
      padding: 5px 10px;
      border: 1px solid #000;
      border-radius: 5px;
      background-color: #000;
      color: #fff;
      cursor: pointer;
    }
    #file-list {
      list-style-type: none;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #file-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    #file-list li a {
      text-decoration: none;
      color: #000;
    }
    #file-list li button {
      margin: 0 5px;
      padding: 5px 10px;
      border: 1px solid #000;
      border-radius: 5px;
      background-color: #000;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Загрузка файлов</h1>
  <form id="file-form" method="post" enctype="multipart/form-data" action="upload.php">
    <label for="file-input">Выберите файл:</label>
    <input type="file" id="file-input" name="file">
    <button type="submit" id="submit-button">Загрузить</button>
  </form>

  <hr>

  <h1>Поиск файлов</h1>
  <form id="search-form">
    <label for="search-input">Поиск по названию файла:</label>
    <input type="text" id="search-input" name="search">
    <button type="button" id="search-button">Найти</button>
  </form>

  <hr>

  <h1>Список файлов</h1>
  <ul id="file-list">
    <?php
      // Функция для безопасного отображения имени файла
      function escape($str) {
        return htmlspecialchars($str, ENT_QUOTES, 'UTF-8');
      }

      // Получение списка файлов из папки "uploads"
      $files = array_diff(scandir('uploads'), array('.', '..'));

      // Вывод списка файлов
      foreach ($files as $file) {
        echo '<li>';
        echo '<a href="download.php?file=' . escape($file) . '">' . escape($file) . '</a>';
        echo ' <button onclick="deleteFile(\'' . escape($file) . '\')">Удалить</button>';
        echo '</li>';
      }
    ?>
  </ul>

  <script>
    // Функция для удаления файла (отправляет AJAX-запрос)
    function deleteFile(fileName) {
      if (confirm(`Удалить файл "${fileName}"?`)) {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'delete.php', true);
        xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhr.onload = function() {
          if (this.status === 200) {
            const response = JSON.parse(this.responseText);
            if (response.success) {
              alert("Файл успешно удален.");
              location.reload();
            } else {
              alert("Ошибка удаления файла.");
            }
          }
        };
        xhr.send('file=' + encodeURIComponent(fileName));
      }
    }

    // Функция для загрузки файла
    const uploadFile = (e) => {
      e.preventDefault(); // предотвращаем отправку формы по умолчанию

      const formData = new FormData(e.target);
      
      fetch('upload.php', { // указываем upload.php как обработчик
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("Файл успешно загружен.");
          window.location.reload();
        } else {
          alert("Ошибка загрузки файла.");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Произошла ошибка при загрузке файла.");
      });

      return false; // запрещаем браузеру обрабатывать форму по умолчанию
    };

    const fileForm = document.getElementById('file-form');
    fileForm.addEventListener('submit', uploadFile);

  </script>
</body>
</html>